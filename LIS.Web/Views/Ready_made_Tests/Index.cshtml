@model IEnumerable<مشروع_ادار_المختبرات.DTOS.PatientDto>

@{
    ViewData["Title"] = "قائمة عرض جميع الطلبات";
}

<div class="container mt-5" style="direction: rtl;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">
            <i class="bi bi-flask me-2"></i>قائمة عرض جميع التحاليل المكتملة
        </h2>
        <a asp-controller="MainScreens" asp-action="Index" class="btn btn-secondary px-4 py-2 rounded-3">
            <i class="bi bi-box-arrow-left"></i> خروج
        </a>
    </div>

    <a asp-controller="UnderAnalysis" asp-action="index" class="link-primary bg-opacity-100 mb-3 d-block">
        عرض الطلبات قيد التحليل
    </a>

    <form asp-action="Index" method="get" class="mb-4">
        <div class="input-group">
            <input type="text" name="name" class="form-control"
                   placeholder="ابحث باسم المريض"
                   value="@Context.Request.Query["name"]" />
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> بحث
            </button>
        </div>
    </form>

    <!-- جدول عرض البيانات -->
    <div class="table-responsive shadow-sm border rounded">
        <table class="table table-hover align-middle text-center" style="font-size:12px">
            <thead class="table-dark">
                <tr>
                    <th>رقم المريض</th>
                    <th>اسم المريض</th>
                    <th>الحالة</th>
                    <th>عدد التحاليل</th>
                    <th style="width:0%">التحاليل</th>
                    <th>تاريخ إنشاء الطلب</th>
                    <th>العمليات</th>
                </tr>
            </thead>
            <tbody>
                @if (Model == null || !Model.Any())
                {
                    <tr>
                        <td colspan="10" class="text-muted py-4">
                            <i class="bi bi-info-circle"></i> لا توجد بيانات لعرضها حالياً
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var patient in Model)
                    {
                        if (patient.Requests != null && patient.Requests.Any())
                        {
                            foreach (var req in patient.Requests.OrderByDescending(r => r.CreatedAt))
                            {
                                <tr>
                                    <td>@patient.PatientID</td>
                                    <td>@patient.PatientName</td>
                                    <td>@req.Status</td>
                                    <td>@(req.Tests != null ? req.Tests.Count() : 0)</td>
                                    <td style="width:30%">
                                        @if(req.Tests != null && req.Tests.Any())
                                        {
                                            @string.Join(", ", req.Tests.Select(t => t.Name))
                                        }
                                        else
                                        {
                                            <text>-</text>
                                        }
                                    </td>
                                    <td>@req.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>
                                        <div class="d-flex justify-content-center gap-2">
                                            <a asp-action="PrintTestResults" asp-controller="Ready_made_Tests" 
                                               asp-route-requestTestId="@req.RequestTestID"
                                               class="btn btn-sm btn-outline-success d-flex align-items-center justify-content-center"
                                               style="width: 100px; height: 35px; font-size: 13px;">
                                                <i class="bi bi-clipboard-plus me-1"></i> اخراج التقرير  
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    }
                }
            </tbody>
        </table>
    </div>
</div>
